## WeiXin进天网项目总结#### 一、项目了解
公司存在两种销售模式，一种是呼叫，一种是微信。呼叫模式因为所有的跟进是通过电话进行，都有录音，所以过程可监控，但是微信则是通过咨询师自己的手机进行，所以在销售过程中有很多问题。
>
1、无法监控咨询师的工作量<br>
2、无法监控咨询师的工作效率及效果<br>
3、无法质检<br>
4、无法有效判单<br>

【由于iOS方案封号风险较大，项目已暂停】
#### 二、主要实现功能
项目主要的实现功能如下：

	1）聊天消息获取【文本、图片、语音及其他消息】
	2）主动添加好友申请以及添加好友成功时好友信息
	3）对方添加好友成功后的好友信息
	4）好友全量数据，重新登录上报全量好友详细数据
	5）删除好友以及被对方删除或拉黑时的消息上报等
	6）后台发指令自动加好友
	7）后台发指令自动打招呼
	8）后台发指令自动群发消息
	9）获取发送朋友圈数据
	10）自动发送朋友圈功能
	…


#### 三、历程回顾
![](http://172.16.117.224/ios-team/ios-team/raw/master/Wiki/zhangyuanke/icon/wx/history.jpg)


#### 四、价值 & 痛点
尽管项目对微信app有风险，但其还是有一定价值的：

	1、了解iOS开发的逆向工程
	2、了解其他主流App的项目架构（Debug可以直接看到Ui层级）
	3、防止自家的App被Hack（必要的话）
	4、感兴趣的话可以hack音乐软件（视频软件）免费下载音乐
	5、如果能够解决目前项目痛点的话价值不可估量，（oops）
项目痛点：目前的方案还是有被微信检测到“使用非官方微信客户端”的情况。<br>
        痛点可能的解决办法：<br>
        1、继续深入当前方案（非侵入性方案考虑<br>
        2、尝试其他可行方案（目前正在执行的是Android方案）
#### 五、项目架构
微信项目的整体架构如下，基本上是依赖iOS运行时的方法替换技术实现。
![](http://172.16.117.224/ios-team/ios-team/raw/master/Wiki/zhangyuanke/icon/wx/framework.jpg)


#### 六、实现步骤 & 关键框架
>
1、开发环境配置（非越狱环境集成微信App） （参考链接） ：<br>
[非越狱环境下从应用重签名到微信上加载Cycript](https://www.jianshu.com/p/262b9849fa10) <br>
[无须越狱、自动集成、只需要一个砸壳的应用](https://www.jianshu.com/p/61c2aca18f0b) <br>
2、环境配置OK后，找到入口方法，进行相关配置<br>
static __attribute__((constructor)) void entry() {} <br>
3、通过JSPatch或者CaptainHook的方式Hook相关方法 <br>
4、对Hook的方法进行处理，获取需要的数据<br>
5、特殊需求功能需要集成第三方框架实现，比如Kif等

JSPatch框架集成：
![](http://172.16.117.224/ios-team/ios-team/raw/master/Wiki/zhangyuanke/icon/wx/jspatch.jpg)
CaptainHook框架集成：
![](http://172.16.117.224/ios-team/ios-team/raw/master/Wiki/zhangyuanke/icon/wx/captaionhook.jpg)


#### 七、项目难点

1、当前新建项目的BundleID和wx一样，com.tencent.xin(因为如果和微信不一样的话，几天就能被检测出来为非官方微信)，解决方案：多个开发者账号来register设备的方式解决，每个开发者账号可以注册100台设备。<br>

2、主动发送消息和发送朋友圈、自动添加好友等功能实现：Kif框架集成，点击功能实现。<br>

3、主动加好友后好友信息不能获取到问题，手机号和微信号搜索，并添加好友，但是如果对方不同意，我们是不能获取到好友的详细信息的，就算是对方同意了，也只能监控到一条消息：“我通过了你的朋友验证请求，现在我们可以开始聊天了”，还是不能获取到详细信息，如何解决，进入通讯录，只要能进入通讯录那么就能获取到某个微信id对应的好友的详细信息了，所以，采取的方案是，通过Kif点击的方式延时进入通讯录，之后把获取的数据再上传。<br>

4、语音文件上报错误，之前不知道微信是如何存储语音文件的，经过观察数据，发现Audio下的某个文件夹下有aud结尾的文件，名称和语音消息的localid一样，那么尝试把aud文件转成mp3，发现和发送的语音确实是一样的（发现了新大陆，当时为了解决语音数据上传花了很多时间），但由于不确定微信是如何存储数据，用了一种笨的方法，遍历Documents文件夹，一层层找Audio文件夹，之后进一步找到了localid.aud文件（当然，不能每一次都这么找，效率也太低了，当时还考虑了缓存最近获取的语音路径）；后来测试发现了问题，上传的语音文件和咨询师实际发送的不一样，才认真的去查找原因和解决。当然，解决方案是根据登录微信的微信id的md5值以及正在聊天的对方微信id的md5值组成的路径即可直接找到对应的语音文件（参考下图）。<br>
![](http://172.16.117.224/ios-team/ios-team/raw/master/Wiki/zhangyuanke/icon/wx/doc.jpg)

5、加好友的过程中屏幕要亮着，屏幕要亮着是微信App需要保活的问题，原因是当时第一版上线后发现咨询师反馈聊天消息未上报，当时觉得不可思议，怎么可能呢（由于当时和上一个Pm达成了协议，咨询师要保证微信一直活着，并且屏幕亮着，但是第二个Pm接手后并不知情，所以未对咨询师进行相关培训）咨询师就把微信打开后，把屏幕关了（😢）。而且咨询师还说，屏幕关了也应该能上报消息啊，要不也太难用了（不用了）（😢）。好吧，还是想想如何解决这个问题吧，“后台保活机制”调研：
最终产出了一篇wiki：
[iOS后台保活之定位&音频](http://172.16.117.224/ios-team/ios-team/issues/19)

6、另外一个问题是如果咨询师操作手机可能会和自动操作手机的动作有冲突，怎么说呢，我们目前的操作手机的方案是通过找到页面以及页面上的元素（UIView），执行点击操作（或者执行window的点击某个区域位置也可），之后等待点击后要进入的页面并进行判断是否是所需页面，如果是继续执行下一步动作，如果不是，等待后再次判断或者重新执行动作，如果多次都不能执行成功则当前自动操作流程失败，之后上报失败消息。那么就会有问题了，如果说自动操作正在执行的过程中，用户点击了页面（比如返回），那么自动操作就极有可能失败，产生问题。<br>
如何解决呢？<br>
一个比较有突破性的方案就是在自动执行动作的过程中添加遮罩，不让用户点击屏幕（后来Android也是用的此方案）。<br>
但是，问题又来了，KIF框架点击功能也被屏蔽了。如何解决？

这个时候想到了一种既可以让KIF框架可以点击，而人不可以点击（理论上人手在极短的时间间隔内也是可以点击的，只不过概率较低而已，可以忽略）的方式，那就是当KIF需要模拟点击某个view之前，先把遮罩视图设置为可以点击，KIF点完了之后立马把遮罩设置为不可点击来解决了当前的问题（😊）。

>
>期待与组内同学一起成长和进步~

#### 祝在尚德工作愉快！
